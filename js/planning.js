// Navbar i≈ülevleri - Weight Tracker'dan alƒ±ndƒ±
function toggleMobileNav() {
  const hamburger = document.getElementById("hamburger");
  const mobileNav = document.getElementById("navMobile");
  const overlay = document.getElementById("navMobileOverlay");

  if (hamburger) hamburger.classList.toggle("active");
  if (mobileNav) mobileNav.classList.toggle("show");
  if (overlay) overlay.classList.toggle("show");

  // Body scroll kontrol√º
  if (mobileNav && mobileNav.classList.contains("show")) {
    document.body.style.overflow = "hidden";
  } else {
    document.body.style.overflow = "";
  }
}

function closeMobileNav() {
  const hamburger = document.getElementById("hamburger");
  const mobileNav = document.getElementById("navMobile");
  const overlay = document.getElementById("navMobileOverlay");

  if (hamburger) hamburger.classList.remove("active");
  if (mobileNav) mobileNav.classList.remove("show");
  if (overlay) overlay.classList.remove("show");
  document.body.style.overflow = "";
}

function toggleProfileDropdown() {
  const dropdown = document.getElementById("profileDropdown");
  if (dropdown) {
    dropdown.classList.toggle("show");
  }
}

function logout() {
  if (confirm("√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?")) {
    showNotification("√áƒ±kƒ±≈ü yapƒ±lƒ±yor... G√ºle g√ºle! üëã", "success");
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  }
}

// Event Handler'larƒ± kur
function setupEventHandlers() {
  // Mobile Navigation
  const hamburger = document.getElementById("hamburger");
  const mobileClose = document.getElementById("navMobileClose");
  const mobileOverlay = document.getElementById("navMobileOverlay");

  if (hamburger) {
    hamburger.addEventListener("click", toggleMobileNav);
  }

  if (mobileClose) {
    mobileClose.addEventListener("click", closeMobileNav);
  }

  if (mobileOverlay) {
    mobileOverlay.addEventListener("click", closeMobileNav);
  }

  // Profile dropdown
  const userAvatar = document.getElementById("userAvatar");
  if (userAvatar) {
    userAvatar.addEventListener("click", function (e) {
      e.stopPropagation();
      toggleProfileDropdown();
    });
  }

  // Settings ve logout butonlarƒ±
  const settingsBtn = document.getElementById("settingsBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  if (settingsBtn) {
    settingsBtn.addEventListener("click", function (e) {
      e.preventDefault();
      window.location.href = "settings.html";
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      logout();
      toggleProfileDropdown();
    });
  }

  // Dropdown dƒ±≈üƒ±na tƒ±klama
  document.addEventListener("click", function (e) {
    const dropdown = document.getElementById("profileDropdown");
    const userAvatar = document.getElementById("userAvatar");

    if (dropdown && !dropdown.contains(e.target) && e.target !== userAvatar) {
      dropdown.classList.remove("show");
    }
  });

  // Bildirim butonu
  const notificationBtn = document.getElementById("notificationBtn");
  if (notificationBtn) {
    notificationBtn.addEventListener("click", function () {
      showNotification(
        "Bildirimler aktif! Yeni √∂zellikler yakƒ±nda gelecek.",
        "info"
      );
    });
  }

  // Klavye kƒ±sayollarƒ±
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeMobileNav();
    }
  });
}

// Global deƒüi≈ükenler
let tasks = [];
let currentView = "kanban";
let currentWeekOffset = 0;
let draggedTask = null;
let currentTaskDetails = null;

// G√∂rev ≈üablonlarƒ±
const taskTemplates = {
  daily: [
    {
      title: "Sabah meditasyonu",
      category: "personal",
      priority: "medium",
      estimate: 15,
    },
    {
      title: "Egzersiz yap",
      category: "health",
      priority: "high",
      estimate: 30,
    },
    {
      title: "G√ºnl√ºk planlama",
      category: "work",
      priority: "medium",
      estimate: 15,
    },
    {
      title: "Su i√ßmeyi unutma",
      category: "health",
      priority: "low",
      estimate: 5,
    },
    {
      title: "Ak≈üam deƒüerlendirmesi",
      category: "personal",
      priority: "low",
      estimate: 10,
    },
  ],
  work: [
    {
      title: "E-postalarƒ± kontrol et",
      category: "work",
      priority: "medium",
      estimate: 30,
    },
    {
      title: "Proje raporunu hazƒ±rla",
      category: "work",
      priority: "high",
      estimate: 120,
    },
    {
      title: "Takƒ±m toplantƒ±sƒ±",
      category: "work",
      priority: "high",
      estimate: 60,
    },
    {
      title: "Sunum hazƒ±rlƒ±ƒüƒ±",
      category: "work",
      priority: "medium",
      estimate: 90,
    },
    {
      title: "M√º≈üteri geri d√∂n√º≈ülerini deƒüerlendir",
      category: "work",
      priority: "medium",
      estimate: 45,
    },
  ],
  study: [
    {
      title: "Ders notlarƒ±nƒ± g√∂zden ge√ßir",
      category: "learning",
      priority: "high",
      estimate: 60,
    },
    { title: "√ñdev yap", category: "learning", priority: "high", estimate: 90 },
    {
      title: "Konu tekrarƒ±",
      category: "learning",
      priority: "medium",
      estimate: 45,
    },
    {
      title: "Sƒ±nav i√ßin √ßalƒ±≈ü",
      category: "learning",
      priority: "high",
      estimate: 120,
    },
    {
      title: "Ara≈ütƒ±rma yap",
      category: "learning",
      priority: "medium",
      estimate: 60,
    },
  ],
  fitness: [
    {
      title: "Kardiyo antrenmanƒ±",
      category: "health",
      priority: "high",
      estimate: 30,
    },
    {
      title: "G√º√ß antrenmanƒ±",
      category: "health",
      priority: "high",
      estimate: 45,
    },
    {
      title: "Yoga seansƒ±",
      category: "health",
      priority: "medium",
      estimate: 30,
    },
    { title: "Y√ºr√ºy√º≈ü yap", category: "health", priority: "low", estimate: 30 },
    {
      title: "Spor programƒ±nƒ± planla",
      category: "health",
      priority: "medium",
      estimate: 15,
    },
  ],
  weekend: [
    {
      title: "Ailenle vakit ge√ßir",
      category: "personal",
      priority: "high",
      estimate: 120,
    },
    {
      title: "Film izle",
      category: "personal",
      priority: "low",
      estimate: 120,
    },
    {
      title: "Arkada≈ülarla bulu≈ü",
      category: "personal",
      priority: "medium",
      estimate: 180,
    },
    {
      title: "Hobi zamanƒ±",
      category: "personal",
      priority: "medium",
      estimate: 60,
    },
    {
      title: "Dinlen ve rahatlat",
      category: "personal",
      priority: "high",
      estimate: 60,
    },
  ],
  cleaning: [
    {
      title: "Evi temizle",
      category: "other",
      priority: "medium",
      estimate: 60,
    },
    {
      title: "√áama≈üƒ±r yƒ±ka",
      category: "other",
      priority: "medium",
      estimate: 30,
    },
    { title: "Bula≈üƒ±k yƒ±ka", category: "other", priority: "low", estimate: 15 },
    {
      title: "S√ºp√ºr ve paspasla",
      category: "other",
      priority: "low",
      estimate: 30,
    },
    {
      title: "D√ºzenleme yap",
      category: "other",
      priority: "low",
      estimate: 45,
    },
  ],
};

// Kategori ikonlarƒ±
const categoryIcons = {
  work: "üíº",
  personal: "üë§",
  health: "üè•",
  learning: "üìö",
  other: "üìã",
};

// G√∂revleri localStorage'dan y√ºkle
function loadTasks() {
  const saved = localStorage.getItem("grindmind_tasks");
  if (saved) {
    tasks = JSON.parse(saved);
  }
  renderCurrentView();
  updateTaskCounts();
}

// G√∂revleri localStorage'a kaydet
function saveTasks() {
  localStorage.setItem("grindmind_tasks", JSON.stringify(tasks));
}

// G√∂r√ºn√ºm deƒüi≈ütir
function switchView(view) {
  currentView = view;

  // Toggle butonlarƒ±nƒ± g√ºncelle
  document.querySelectorAll(".toggle-btn").forEach((btn) => {
    btn.classList.remove("active");
  });
  document.querySelector(`[data-view="${view}"]`).classList.add("active");

  // G√∂r√ºn√ºmleri deƒüi≈ütir
  document
    .querySelectorAll(".kanban-view, .calendar-view, .stats-view")
    .forEach((el) => {
      el.classList.remove("active");
    });
  document.getElementById(`${view}View`).classList.add("active");

  renderCurrentView();
}

// Mevcut g√∂r√ºn√ºm√º render et
function renderCurrentView() {
  switch (currentView) {
    case "kanban":
      renderKanbanBoard();
      break;
    case "calendar":
      renderWeeklyCalendar();
      break;
    case "stats":
      renderStatistics();
      break;
  }

  // Her render'dan sonra drag&drop listener'larƒ±nƒ± yeniden kur
  setTimeout(setupDragDropListeners, 100);
}

// Kanban board'u render et - sadece scheduledDay olmayan g√∂revleri g√∂ster
function renderKanbanBoard() {
  const todoList = document.getElementById("todoList");
  const inProgressList = document.getElementById("inProgressList");
  const doneList = document.getElementById("doneList");

  // Listeleri temizle
  todoList.innerHTML = "";
  inProgressList.innerHTML = "";
  doneList.innerHTML = "";

  // Sadece scheduledDay'i olmayan g√∂revleri kanban'da g√∂ster
  const kanbanTasks = tasks.filter((task) => !task.scheduledDay);

  kanbanTasks.forEach((task) => {
    const taskElement = createTaskCard(task);

    switch (task.status) {
      case "todo":
        todoList.appendChild(taskElement);
        break;
      case "in-progress":
        inProgressList.appendChild(taskElement);
        break;
      case "done":
        doneList.appendChild(taskElement);
        break;
    }
  });

  updateTaskCounts();
}

// G√∂rev kartƒ± olu≈ütur
function createTaskCard(task) {
  const card = document.createElement("div");
  card.className = "task-card";
  card.draggable = true;
  card.dataset.taskId = task.id;

  // Biti≈ü tarihi kontrol√º
  let dueDateClass = "";
  let dueDateText = "";
  if (task.dueDate) {
    const today = new Date();
    const dueDate = new Date(task.dueDate);
    const diffTime = dueDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 0) {
      dueDateClass = "overdue";
      dueDateText = `${Math.abs(diffDays)} g√ºn gecikmi≈ü`;
    } else if (diffDays === 0) {
      dueDateClass = "today";
      dueDateText = "Bug√ºn";
    } else {
      dueDateText = dueDate.toLocaleDateString("tr-TR");
    }
  }

  card.innerHTML = `
    <div class="task-header">
      <div class="task-priority ${task.priority}">${getPriorityText(
    task.priority
  )}</div>
    </div>
    <div class="task-title">${task.title}</div>
    ${
      task.description
        ? `<div class="task-description">${task.description}</div>`
        : ""
    }
    <div class="task-meta">
      <span class="task-category">${
        categoryIcons[task.category]
      } ${getCategoryText(task.category)}</span>
      ${
        task.dueDate
          ? `<span class="task-due-date ${dueDateClass}">${dueDateText}</span>`
          : ""
      }
    </div>
  `;

  // Event listeners
  card.addEventListener("dragstart", handleDragStart);
  card.addEventListener("dragend", handleDragEnd);
  card.addEventListener("click", () => showTaskDetails(task.id));

  return card;
}

// G√∂r√ºnt√ºlenen haftaya ait tarihleri hesapla
function getCurrentWeekDates() {
  const today = new Date();
  // currentWeekOffset'i kullanarak doƒüru haftayƒ± hesapla
  const targetWeek = new Date(
    today.getTime() + currentWeekOffset * 7 * 24 * 60 * 60 * 1000
  );

  // Haftanƒ±n pazartesisini bul
  const monday = new Date(targetWeek);
  const dayOfWeek = monday.getDay();
  const diff = monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Pazar g√ºn√º 0 olduƒüu i√ßin √∂zel durum
  monday.setDate(diff);

  const weekDates = {};
  const days = [
    "monday",
    "tuesday",
    "wednesday",
    "thursday",
    "friday",
    "saturday",
    "sunday",
  ];

  days.forEach((day, index) => {
    const date = new Date(monday.getTime() + index * 24 * 60 * 60 * 1000);
    weekDates[day] = date.toISOString().split("T")[0]; // YYYY-MM-DD formatƒ±nda
  });

  return weekDates;
}

// Haftalƒ±k takvimi render et - tarihe g√∂re filtrelenmi≈ü g√∂revler
function renderWeeklyCalendar() {
  updateWeekDates();

  // G√ºnl√ºk g√∂rev listelerini temizle
  const days = [
    "monday",
    "tuesday",
    "wednesday",
    "thursday",
    "friday",
    "saturday",
    "sunday",
  ];
  days.forEach((day) => {
    document.getElementById(`${day}Tasks`).innerHTML = "";
  });

  // Mevcut g√∂r√ºnt√ºlenen haftanƒ±n tarihlerini al
  const weekDates = getCurrentWeekDates();

  console.log("G√∂r√ºnt√ºlenen hafta tarihleri:", weekDates);
  console.log("Current week offset:", currentWeekOffset);

  // G√∂revleri g√ºnlere daƒüƒ±t
  tasks.forEach((task) => {
    let targetDay = null;

    // 1. √ñnce scheduledDay'e bak - eƒüer varsa ve g√∂r√ºnt√ºlenen haftadaysa g√∂ster
    if (task.scheduledDay && weekDates[task.scheduledDay]) {
      // ScheduledDay varsa ama dueDate de varsa, dueDate'in bu haftada olup olmadƒ±ƒüƒ±nƒ± kontrol et
      if (task.dueDate) {
        const taskDate = task.dueDate;
        // DueDate g√∂r√ºnt√ºlenen haftada mƒ±?
        const isInCurrentWeek = Object.values(weekDates).includes(taskDate);
        if (isInCurrentWeek) {
          targetDay = task.scheduledDay;
        }
      } else {
        // DueDate yoksa sadece scheduledDay'e g√∂re g√∂ster (eski davranƒ±≈ü i√ßin)
        // Ama bunun i√ßin de bir hafta kontrol√º yapalƒ±m
        targetDay = task.scheduledDay;
      }
    }
    // 2. ScheduledDay yoksa ama dueDate varsa, tarihe g√∂re yerle≈ütir
    else if (!task.scheduledDay && task.dueDate) {
      const taskDate = task.dueDate;

      // Bu tarih g√∂r√ºnt√ºlenen haftada hangi g√ºne denk geliyor?
      Object.keys(weekDates).forEach((day) => {
        if (weekDates[day] === taskDate) {
          targetDay = day;
        }
      });
    }

    // Hedef g√ºn bulunduysa ve scheduledDay varsa g√∂revi yerle≈ütir
    if (targetDay && task.scheduledDay) {
      const dayTasks = document.getElementById(`${targetDay}Tasks`);
      if (dayTasks) {
        const taskElement = createDayTaskCard(task);
        dayTasks.appendChild(taskElement);
      }
    }
  });
}

// G√ºnl√ºk g√∂rev kartƒ± olu≈ütur
function createDayTaskCard(task) {
  const card = document.createElement("div");
  card.className = "day-task";
  card.draggable = true;
  card.dataset.taskId = task.id;

  card.innerHTML = `
    <div class="task-title">${task.title}</div>
    <div class="task-meta">
      <span class="task-priority ${task.priority}">${getPriorityText(
    task.priority
  )}</span>
      <span class="task-category">${categoryIcons[task.category]}</span>
    </div>
  `;

  card.addEventListener("dragstart", handleDragStart);
  card.addEventListener("dragend", handleDragEnd);
  card.addEventListener("click", () => showTaskDetails(task.id));

  return card;
}

// Hafta tarihlerini g√ºncelle
function updateWeekDates() {
  const today = new Date();
  const currentWeek = new Date(
    today.getTime() + currentWeekOffset * 7 * 24 * 60 * 60 * 1000
  );

  // Haftanƒ±n pazartesisini bul
  const monday = new Date(currentWeek);
  monday.setDate(currentWeek.getDate() - currentWeek.getDay() + 1);

  // Hafta ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
  const weekStart = monday.toLocaleDateString("tr-TR");
  const weekEnd = new Date(
    monday.getTime() + 6 * 24 * 60 * 60 * 1000
  ).toLocaleDateString("tr-TR");
  document.getElementById(
    "currentWeek"
  ).textContent = `${weekStart} - ${weekEnd}`;

  // G√ºnl√ºk tarihleri g√ºncelle
  const days = [
    "monday",
    "tuesday",
    "wednesday",
    "thursday",
    "friday",
    "saturday",
    "sunday",
  ];
  days.forEach((day, index) => {
    const date = new Date(monday.getTime() + index * 24 * 60 * 60 * 1000);
    document.getElementById(`${day}Date`).textContent =
      date.toLocaleDateString("tr-TR");

    // Bug√ºn√º vurgula (sadece mevcut haftadaysa)
    const dayElement = document.querySelector(`[data-day="${day}"]`);
    if (
      currentWeekOffset === 0 &&
      date.toDateString() === today.toDateString()
    ) {
      dayElement.classList.add("today");
    } else {
      dayElement.classList.remove("today");
    }
  });
}

// Hafta deƒüi≈ütir
function changeWeek(direction) {
  currentWeekOffset += direction;
  renderWeeklyCalendar();
}

// ƒ∞statistikleri render et
function renderStatistics() {
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter((t) => t.status === "done").length;
  const pendingTasks = tasks.filter(
    (t) => t.status === "todo" || t.status === "in-progress"
  ).length;

  // Geciken g√∂revleri hesapla
  const today = new Date();
  const overdueTasks = tasks.filter((t) => {
    if (!t.dueDate || t.status === "done") return false;
    const dueDate = new Date(t.dueDate);
    return dueDate < today;
  }).length;

  // ƒ∞statistik kartlarƒ±nƒ± g√ºncelle
  document.getElementById("totalTasks").textContent = totalTasks;
  document.getElementById("completedTasks").textContent = completedTasks;
  document.getElementById("pendingTasks").textContent = pendingTasks;
  document.getElementById("overdueTasks").textContent = overdueTasks;

  // Grafikleri olu≈ütur
  setTimeout(() => {
    createWeeklyPerformanceChart();
    createTaskDistributionChart();
  }, 100);
}

// Haftalƒ±k performans grafiƒüi
function createWeeklyPerformanceChart() {
  const ctx = document
    .getElementById("weeklyPerformanceChart")
    .getContext("2d");

  // Son 7 g√ºn√ºn verilerini hazƒ±rla
  const last7Days = [];
  const completedData = [];
  const createdData = [];

  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split("T")[0];

    last7Days.push(date.toLocaleDateString("tr-TR", { weekday: "short" }));

    const completed = tasks.filter(
      (t) =>
        t.status === "done" &&
        t.completedDate &&
        t.completedDate.startsWith(dateStr)
    ).length;

    const created = tasks.filter(
      (t) => t.createdDate && t.createdDate.startsWith(dateStr)
    ).length;

    completedData.push(completed);
    createdData.push(created);
  }

  new Chart(ctx, {
    type: "line",
    data: {
      labels: last7Days,
      datasets: [
        {
          label: "Tamamlanan",
          data: completedData,
          borderColor: "#10b981",
          backgroundColor: "rgba(16, 185, 129, 0.1)",
          borderWidth: 3,
          fill: true,
          tension: 0.4,
        },
        {
          label: "Olu≈üturulan",
          data: createdData,
          borderColor: "#6366f1",
          backgroundColor: "rgba(99, 102, 241, 0.1)",
          borderWidth: 3,
          fill: true,
          tension: 0.4,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "top",
        },
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
          },
        },
      },
    },
  });
}

// G√∂rev daƒüƒ±lƒ±m grafiƒüi
function createTaskDistributionChart() {
  const ctx = document.getElementById("taskDistributionChart").getContext("2d");

  const statusCounts = {
    todo: tasks.filter((t) => t.status === "todo").length,
    "in-progress": tasks.filter((t) => t.status === "in-progress").length,
    done: tasks.filter((t) => t.status === "done").length,
  };

  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Yapƒ±lacak", "Devam Ediyor", "Tamamlandƒ±"],
      datasets: [
        {
          data: [
            statusCounts.todo,
            statusCounts["in-progress"],
            statusCounts.done,
          ],
          backgroundColor: ["#f59e0b", "#6366f1", "#10b981"],
          borderWidth: 3,
          borderColor: "#ffffff",
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "bottom",
        },
      },
    },
  });
}

// G√∂rev sayƒ±larƒ±nƒ± g√ºncelle - sadece kanban g√∂revleri
function updateTaskCounts() {
  const kanbanTasks = tasks.filter((task) => !task.scheduledDay);

  const todoCount = kanbanTasks.filter((t) => t.status === "todo").length;
  const inProgressCount = kanbanTasks.filter(
    (t) => t.status === "in-progress"
  ).length;
  const doneCount = kanbanTasks.filter((t) => t.status === "done").length;

  document.getElementById("todoCount").textContent = todoCount;
  document.getElementById("inProgressCount").textContent = inProgressCount;
  document.getElementById("doneCount").textContent = doneCount;
}

// Yeni g√∂rev modal'ƒ±nƒ± g√∂ster
function showAddTaskModal(defaultStatus = "todo", defaultDay = "") {
  document.getElementById("addTaskModal").style.display = "block";

  // Formu temizle
  document.getElementById("taskTitle").value = "";
  document.getElementById("taskDescription").value = "";
  document.getElementById("taskPriority").value = "medium";
  document.getElementById("taskCategory").value = "work";
  document.getElementById("taskDueDate").value = "";
  document.getElementById("taskEstimate").value = "60";
  document.getElementById("taskDay").value = defaultDay;

  // Eƒüer belirli bir g√ºn i√ßin g√∂rev ekleniyorsa, o g√ºn√ºn tarihini dueDate olarak ayarla
  if (defaultDay) {
    const weekDates = getCurrentWeekDates();
    if (weekDates[defaultDay]) {
      document.getElementById("taskDueDate").value = weekDates[defaultDay];
    }
  }

  // Varsayƒ±lan durumu sakla
  document.getElementById("addTaskModal").dataset.defaultStatus = defaultStatus;
}

// Yeni g√∂rev ekle
function addTask() {
  const title = document.getElementById("taskTitle").value.trim();
  if (!title) {
    showNotification("G√∂rev ba≈ülƒ±ƒüƒ± gerekli!", "error");
    return;
  }

  const defaultStatus =
    document.getElementById("addTaskModal").dataset.defaultStatus || "todo";

  const scheduledDay = document.getElementById("taskDay").value;
  const dueDate = document.getElementById("taskDueDate").value;

  const newTask = {
    id: Date.now(),
    title: title,
    description: document.getElementById("taskDescription").value.trim(),
    priority: document.getElementById("taskPriority").value,
    category: document.getElementById("taskCategory").value,
    status: defaultStatus,
    dueDate: dueDate,
    estimatedTime: parseInt(document.getElementById("taskEstimate").value),
    scheduledDay: scheduledDay,
    createdDate: new Date().toISOString(),
    completedDate: null,
  };

  tasks.push(newTask);
  saveTasks();
  renderCurrentView();
  closeModal("addTaskModal");

  showNotification("üéâ G√∂rev ba≈üarƒ±yla eklendi!", "success");
}

// G√∂rev detaylarƒ±nƒ± g√∂ster
function showTaskDetails(taskId) {
  const task = tasks.find((t) => t.id === taskId);
  if (!task) return;

  currentTaskDetails = task;

  document.getElementById("taskDetailsTitle").textContent = task.title;

  const detailsBody = document.getElementById("taskDetailsBody");
  detailsBody.innerHTML = `
    <div class="task-detail-section">
      <h4>üìã Genel Bilgiler</h4>
      <div class="detail-info">
        <strong>Durum:</strong> ${getStatusText(task.status)}<br>
        <strong>√ñncelik:</strong> ${getPriorityText(task.priority)}<br>
        <strong>Kategori:</strong> ${
          categoryIcons[task.category]
        } ${getCategoryText(task.category)}<br>
        ${
          task.estimatedTime
            ? `<strong>Tahmini S√ºre:</strong> ${task.estimatedTime} dakika<br>`
            : ""
        }
        ${
          task.scheduledDay
            ? `<strong>Planlanan G√ºn:</strong> ${getDayText(
                task.scheduledDay
              )}<br>`
            : ""
        }
        ${
          task.dueDate
            ? `<strong>Biti≈ü Tarihi:</strong> ${new Date(
                task.dueDate
              ).toLocaleDateString("tr-TR")}<br>`
            : ""
        }
      </div>
    </div>
    
    ${
      task.description
        ? `
    <div class="task-detail-section">
      <h4>üìù A√ßƒ±klama</h4>
      <div class="detail-info">${task.description}</div>
    </div>
    `
        : ""
    }
    
    <div class="task-detail-section">
      <h4>üìÖ Zaman Bilgileri</h4>
      <div class="detail-info">
        <strong>Olu≈üturulma:</strong> ${new Date(
          task.createdDate
        ).toLocaleString("tr-TR")}<br>
        ${
          task.completedDate
            ? `<strong>Tamamlanma:</strong> ${new Date(
                task.completedDate
              ).toLocaleString("tr-TR")}`
            : ""
        }
      </div>
    </div>
  `;

  document.getElementById("taskDetailsModal").style.display = "block";
}

// G√∂rev d√ºzenle
function editTask() {
  if (!currentTaskDetails) return;

  // D√ºzenleme modal'ƒ±nƒ± g√∂ster (add modal'ƒ±nƒ± kullan)
  document.getElementById("taskTitle").value = currentTaskDetails.title;
  document.getElementById("taskDescription").value =
    currentTaskDetails.description || "";
  document.getElementById("taskPriority").value = currentTaskDetails.priority;
  document.getElementById("taskCategory").value = currentTaskDetails.category;
  document.getElementById("taskDueDate").value =
    currentTaskDetails.dueDate || "";
  document.getElementById("taskEstimate").value =
    currentTaskDetails.estimatedTime || 60;
  document.getElementById("taskDay").value =
    currentTaskDetails.scheduledDay || "";

  // Modal'ƒ± d√ºzenleme moduna al
  document.getElementById("addTaskModal").dataset.editingId =
    currentTaskDetails.id;
  document.querySelector("#addTaskModal .modal-header h3").textContent =
    "G√∂rev D√ºzenle";
  document.querySelector("#addTaskModal .modal-btn.btn-primary").textContent =
    "G√ºncelle";

  closeModal("taskDetailsModal");
  document.getElementById("addTaskModal").style.display = "block";
}

// G√∂rev sil
function deleteTask() {
  if (!currentTaskDetails) return;

  if (
    confirm(
      `"${currentTaskDetails.title}" g√∂revini silmek istediƒüinizden emin misiniz?`
    )
  ) {
    tasks = tasks.filter((t) => t.id !== currentTaskDetails.id);
    saveTasks();
    renderCurrentView();
    closeModal("taskDetailsModal");
    showNotification("G√∂rev silindi.", "info");
  }
}

// ≈ûablonlarƒ± g√∂ster
function showTemplatesModal() {
  document.getElementById("templatesModal").style.display = "block";
}

// ≈ûablon y√ºkle
function loadTemplate(templateType) {
  const template = taskTemplates[templateType];
  if (!template) return;

  const newTasks = template.map((taskData) => ({
    id: Date.now() + Math.random(),
    title: taskData.title,
    description: "",
    priority: taskData.priority,
    category: taskData.category,
    status: "todo",
    dueDate: "",
    estimatedTime: taskData.estimate,
    scheduledDay: "",
    createdDate: new Date().toISOString(),
    completedDate: null,
  }));

  tasks.push(...newTasks);
  saveTasks();
  renderCurrentView();
  closeModal("templatesModal");

  showNotification(
    `üéâ ${template.length} g√∂rev ${getTemplateText(
      templateType
    )} ≈üablonundan eklendi!`,
    "success"
  );
}

// G√∂revleri dƒ±≈üa aktar
function exportTasks() {
  const dataStr = JSON.stringify(tasks, null, 2);
  const dataBlob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(dataBlob);

  const link = document.createElement("a");
  link.href = url;
  link.download = `grindmind-tasks-${
    new Date().toISOString().split("T")[0]
  }.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  showNotification("G√∂revler dƒ±≈üa aktarƒ±ldƒ±!", "success");
}

// Drag & Drop i≈ülemleri
function handleDragStart(e) {
  draggedTask = e.target;
  draggedTask.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", e.target.dataset.taskId);
}

function handleDragEnd(e) {
  if (draggedTask) {
    draggedTask.classList.remove("dragging");

    // T√ºm drag-over sƒ±nƒ±flarƒ±nƒ± temizle
    document.querySelectorAll(".task-list, .day-tasks").forEach((list) => {
      list.classList.remove("drag-over");
    });

    draggedTask = null;
  }
}

function allowDrop(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}

function drop(e) {
  e.preventDefault();

  const taskId = e.dataTransfer.getData("text/plain");
  if (!taskId) return;

  const taskList = e.currentTarget;
  const newStatus = taskList.parentElement.dataset.status;

  // G√∂rsel geri bildirimi kaldƒ±r
  taskList.classList.remove("drag-over");

  // G√∂rev durumunu g√ºncelle
  const task = tasks.find((t) => t.id == taskId);
  if (task && task.status !== newStatus) {
    task.status = newStatus;

    // Kanban board'a ta≈üƒ±nƒ±rsa scheduledDay'i temizle
    if (taskList.closest(".kanban-column")) {
      task.scheduledDay = "";
    }

    if (newStatus === "done" && !task.completedDate) {
      task.completedDate = new Date().toISOString();
    } else if (newStatus !== "done") {
      task.completedDate = null;
    }

    saveTasks();
    renderCurrentView();

    showNotification(
      `G√∂rev "${getStatusText(newStatus)}" durumuna ta≈üƒ±ndƒ±.`,
      "success"
    );
  }
}

function dropToDay(e, day) {
  e.preventDefault();

  const taskId = e.dataTransfer.getData("text/plain");
  if (!taskId) return;

  const task = tasks.find((t) => t.id == taskId);

  // G√∂rsel geri bildirimi kaldƒ±r
  e.currentTarget.classList.remove("drag-over");

  if (task) {
    // Mevcut haftanƒ±n tarihlerini al
    const weekDates = getCurrentWeekDates();

    // G√∂revin planlanan g√ºn√ºn√º ve tarihini g√ºncelle
    task.scheduledDay = day;
    task.dueDate = weekDates[day]; // Tarihi de otomatik ayarla

    saveTasks();
    renderCurrentView();

    showNotification(`G√∂rev ${getDayText(day)} g√ºn√ºne planlandƒ±.`, "success");
  }
}

// Drag over efektleri i√ßin yardƒ±mcƒ± fonksiyonlar
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add("drag-over");
}

function handleDragLeave(e) {
  // Sadece ger√ßekten element'ten √ßƒ±kƒ±ldƒ±ƒüƒ±nda kaldƒ±r
  const rect = e.currentTarget.getBoundingClientRect();
  const x = e.clientX;
  const y = e.clientY;

  if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
    e.currentTarget.classList.remove("drag-over");
  }
}

// Event listener'larƒ± ayarla
function setupDragDropListeners() {
  // Kanban kolonlarƒ± i√ßin
  document.querySelectorAll(".task-list").forEach((list) => {
    list.addEventListener("dragover", handleDragOver);
    list.addEventListener("dragleave", handleDragLeave);
    list.addEventListener("drop", drop);
  });

  // Haftalƒ±k takvim g√ºnleri i√ßin
  document.querySelectorAll(".day-tasks").forEach((dayTask) => {
    const day = dayTask.parentElement.dataset.day;
    dayTask.addEventListener("dragover", handleDragOver);
    dayTask.addEventListener("dragleave", handleDragLeave);
    dayTask.addEventListener("drop", (e) => dropToDay(e, day));
  });
}

// Yardƒ±mcƒ± fonksiyonlar
function getPriorityText(priority) {
  const priorities = {
    low: "D√º≈ü√ºk üü¢",
    medium: "Orta üü°",
    high: "Y√ºksek üî¥",
  };
  return priorities[priority] || priority;
}

function getCategoryText(category) {
  const categories = {
    work: "ƒ∞≈ü",
    personal: "Ki≈üisel",
    health: "Saƒülƒ±k",
    learning: "√ñƒürenme",
    other: "Diƒüer",
  };
  return categories[category] || category;
}

function getStatusText(status) {
  const statuses = {
    todo: "Yapƒ±lacak",
    "in-progress": "Devam Ediyor",
    done: "Tamamlandƒ±",
  };
  return statuses[status] || status;
}

function getDayText(day) {
  const days = {
    monday: "Pazartesi",
    tuesday: "Salƒ±",
    wednesday: "√áar≈üamba",
    thursday: "Per≈üembe",
    friday: "Cuma",
    saturday: "Cumartesi",
    sunday: "Pazar",
  };
  return days[day] || day;
}

function getTemplateText(template) {
  const templates = {
    daily: "G√ºnl√ºk Rutin",
    work: "ƒ∞≈ü G√∂revleri",
    study: "√áalƒ±≈üma Planƒ±",
    fitness: "Fitness Programƒ±",
    weekend: "Hafta Sonu",
    cleaning: "Ev ƒ∞≈üleri",
  };
  return templates[template] || template;
}

// Modal i≈ülemleri
function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";

  // Add modal'ƒ±nƒ± temizle
  if (modalId === "addTaskModal") {
    delete document.getElementById("addTaskModal").dataset.editingId;
    document.querySelector("#addTaskModal .modal-header h3").textContent =
      "Yeni G√∂rev Ekle";
    document.querySelector("#addTaskModal .modal-btn.btn-primary").textContent =
      "G√∂rev Ekle";
  }
}

// Bildirim g√∂ster - Weight Tracker'dan alƒ±ndƒ±
function showNotification(message, type = "success") {
  const notification = document.createElement("div");
  notification.className = "notification";

  const colors = {
    success: "#10b981",
    error: "#ef4444",
    warning: "#f59e0b",
    info: "#6366f1",
  };

  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colors[type] || colors.success};
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    font-weight: 500;
    z-index: 10000;
    max-width: 300px;
    animation: slideIn 0.5s ease;
    cursor: pointer;
  `;

  notification.textContent = message;
  document.body.appendChild(notification);

  // 5 saniye sonra kaldƒ±r
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.animation = "slideIn 0.5s ease reverse";
      setTimeout(() => {
        notification.parentNode.removeChild(notification);
      }, 500);
    }
  }, 5000);

  // Tƒ±klanƒ±nca kaldƒ±r
  notification.addEventListener("click", () => {
    notification.style.animation = "slideIn 0.5s ease reverse";
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 500);
  });
}

// Modal dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
window.addEventListener("click", function (e) {
  if (e.target.classList.contains("modal")) {
    e.target.style.display = "none";
  }
});

// Klavye kƒ±sayollarƒ±
document.addEventListener("keydown", function (e) {
  // Escape tu≈üu - t√ºm modal'larƒ± kapat
  if (e.key === "Escape") {
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.style.display = "none";
    });
  }

  // Ctrl/Cmd + N - Yeni g√∂rev ekle
  if ((e.ctrlKey || e.metaKey) && e.key === "n") {
    e.preventDefault();
    showAddTaskModal();
  }

  // Ctrl/Cmd + S - ƒ∞statistikleri g√∂ster
  if ((e.ctrlKey || e.metaKey) && e.key === "s") {
    e.preventDefault();
    switchView("stats");
  }

  // Ctrl/Cmd + K - Kanban g√∂r√ºn√ºm√º
  if ((e.ctrlKey || e.metaKey) && e.key === "k") {
    e.preventDefault();
    switchView("kanban");
  }

  // Ctrl/Cmd + W - Haftalƒ±k takvim g√∂r√ºn√ºm√º
  if ((e.ctrlKey || e.metaKey) && e.key === "w") {
    e.preventDefault();
    switchView("calendar");
  }
});

// Add Task modal'ƒ±ndaki form submit i≈ülemi
document.addEventListener("DOMContentLoaded", function () {
  const addTaskForm = document.querySelector("#addTaskModal .modal-body");
  if (addTaskForm) {
    addTaskForm.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();

        // D√ºzenleme modunda mƒ± kontrol et
        const editingId =
          document.getElementById("addTaskModal").dataset.editingId;
        if (editingId) {
          updateTask(parseInt(editingId));
        } else {
          addTask();
        }
      }
    });
  }
});

// G√∂rev g√ºncelleme fonksiyonu
function updateTask(taskId) {
  const title = document.getElementById("taskTitle").value.trim();
  if (!title) {
    showNotification("G√∂rev ba≈ülƒ±ƒüƒ± gerekli!", "error");
    return;
  }

  const taskIndex = tasks.findIndex((t) => t.id === taskId);
  if (taskIndex === -1) return;

  const scheduledDay = document.getElementById("taskDay").value;
  const dueDate = document.getElementById("taskDueDate").value;

  // G√∂rev bilgilerini g√ºncelle
  tasks[taskIndex] = {
    ...tasks[taskIndex],
    title: title,
    description: document.getElementById("taskDescription").value.trim(),
    priority: document.getElementById("taskPriority").value,
    category: document.getElementById("taskCategory").value,
    dueDate: dueDate,
    estimatedTime: parseInt(document.getElementById("taskEstimate").value),
    scheduledDay: scheduledDay,
    updatedDate: new Date().toISOString(),
  };

  saveTasks();
  renderCurrentView();
  closeModal("addTaskModal");

  showNotification("üéâ G√∂rev ba≈üarƒ±yla g√ºncellendi!", "success");
}

// G√∂rev arama fonksiyonu
function searchTasks(query) {
  if (!query) return tasks;

  query = query.toLowerCase();
  return tasks.filter(
    (task) =>
      task.title.toLowerCase().includes(query) ||
      (task.description && task.description.toLowerCase().includes(query)) ||
      getCategoryText(task.category).toLowerCase().includes(query)
  );
}

// Otomatik kaydetme sistemi
let autoSaveTimeout;
function autoSave() {
  clearTimeout(autoSaveTimeout);
  autoSaveTimeout = setTimeout(() => {
    saveTasks();
  }, 1000);
}

// Performans istatistikleri
function getProductivityStats() {
  const today = new Date();
  const thisWeek = [];

  // Bu haftanƒ±n g√ºnlerini al
  for (let i = 0; i < 7; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() - today.getDay() + i);
    thisWeek.push(date.toISOString().split("T")[0]);
  }

  const thisWeekCompleted = tasks.filter(
    (t) =>
      t.status === "done" &&
      t.completedDate &&
      thisWeek.some((day) => t.completedDate.startsWith(day))
  ).length;

  const thisWeekCreated = tasks.filter(
    (t) =>
      t.createdDate && thisWeek.some((day) => t.createdDate.startsWith(day))
  ).length;

  return {
    weeklyCompletion: thisWeekCompleted,
    weeklyCreation: thisWeekCreated,
    completionRate:
      thisWeekCreated > 0
        ? Math.round((thisWeekCompleted / thisWeekCreated) * 100)
        : 0,
  };
}

// Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
document.addEventListener("DOMContentLoaded", function () {
  console.log("üìã Planlama & G√∂revler sayfasƒ± y√ºklendi");

  // Event handler'larƒ± kur
  setupEventHandlers();

  // G√∂revleri y√ºkle
  loadTasks();

  // Varsayƒ±lan olarak kanban g√∂r√ºn√ºm√ºn√º g√∂ster
  switchView("kanban");

  // Haftalƒ±k takvim i√ßin bug√ºn√ºn tarihini ayarla
  updateWeekDates();

  // Otomatik kaydetme i√ßin event listener'lar ekle
  document.addEventListener("input", autoSave);
  document.addEventListener("change", autoSave);
});

// Debug fonksiyonu
window.debugTasks = function () {
  console.log("=== G√ñREV Lƒ∞STESƒ∞ DEBUG ===");
  console.log("Toplam g√∂rev sayƒ±sƒ±:", tasks.length);
  console.log("G√∂revler:", tasks);
  console.log("Performans istatistikleri:", getProductivityStats());
  console.log(
    "Kanban g√∂revleri:",
    tasks.filter((task) => !task.scheduledDay)
  );
  console.log(
    "Planlƒ± g√∂revler:",
    tasks.filter((task) => task.scheduledDay)
  );
  console.log("Mevcut hafta offset:", currentWeekOffset);
  console.log("Mevcut hafta tarihleri:", getCurrentWeekDates());

  // Haftalƒ±k program i√ßin detaylƒ± debug
  console.log("--- HAFTALIK PROGRAM DEBUG ---");
  const weekDates = getCurrentWeekDates();
  Object.keys(weekDates).forEach((day) => {
    const dayTasks = tasks.filter((task) => {
      return (
        task.scheduledDay === day &&
        task.dueDate &&
        Object.values(weekDates).includes(task.dueDate)
      );
    });
    console.log(
      `${day} (${weekDates[day]}):`,
      dayTasks.length,
      "g√∂rev",
      dayTasks
    );
  });
};
